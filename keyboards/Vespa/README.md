# Vespa ユーザガイド

<!-- ## 注意事項

本製品はDIYキットです．十分注意して作業を行うようにしてください．

また，本製品の使用によって発生するいかなる損失についても，使用者の自己責任とします。

## 内容物と別途必要なもの

| 内容物 | 個数 |
|------|------|
| M2 5mmネジ | 16本 |
| M2 8mmスペーサー | 8個 |
| メイン基板 | 1枚 |
| ボトムプレート | 1枚 |
| トッププレート | 1枚 |
| ゴム足 | 5個 |

もし不足があった場合は，お問い合わせより報告をお願いいたします．
M2ネジを留めるための精密ドライバーが工具として必要です．

## 組み立て
 -->

## 各部名称

![Vespa各部名称](../assets/vespa/vespa.webp)

電源スイッチは右側がオン，左側がオフです．

## 電源

### 電池を使用する場合

> [!CAUTION]
> - 使用可能な電池は単三形乾電池または充電式ニッケル水素電池(エネループ等)です．
> - 電池の交換は，必ず電源を切ってから行ってください．
> - 電池を交換する際は，電池ホルダの上下部分を押さえて交換してください．
> - 電池は正しい向き(+極が上)で挿入してください．逆向きに挿入すると故障の原因となります．
> - 電池が切れた場合，速やかに取り除いてください．
> - 長期間使用しない場合，電池を取り除いてください．

1. キーボードの電源スイッチがオフの位置になっており，USBケーブルが接続されていないことを確認します．
2. キーボード中央部の電池ホルダに電池を挿入します．
3. キーボードの電源スイッチをオンの位置に切り替えます．

### USBケーブルを使用する場合

USB Type-Cケーブルを使用してキーボードを接続します．

> [!NOTE]
> - 長期間USB接続で使用する場合，電池を取り除いてください．
> - 電源スイッチは電池の接続にのみ影響し，USB接続には影響しません．

### スリープ機能

30分間キー入力がない場合，キーボードはスリープモードに入ります．
スリープモードから復帰するには，任意のキーを押してください．
スリープからの復帰には数秒かかる場合があります．

スリープ機能をオフにする方法については，後述の「[スリープ機能をオフにする](#スリープ機能をオフにする)」を参照してください．

> [!TIP]
> 通常使用時はスリープ機能を活用し，電源スイッチは持ち運び時などに使用することをお勧めします．

## キーボードをBluetoothで接続する

1. キーボードの電源スイッチをオンの位置に切り替えます．
2. 接続先端末(パソコン等)のBluetooth設定画面を開きます．
3. "Vespa"を選択してペアリングを行います．

左Shiftの右にあるキーや右Shiftの左にあるキーを押すように求められた場合，それぞれ`Z`および`/`キーを押してください．
入力方式を選択するように求められた場合，ANSI（US・米国配列）を選択してください．
JIS入力(例えば，`Shift`+`2`で`@`ではなく`"`が入力されるもの)を使用したい場合，後述の「[キーマップの変更](#キーマップの変更)」を参照して，所望のキー配置に変更した後，PC等の設定でキーボードの種類・レイアウトをJIS（日本語）に変更してください．

## キーマップ

デフォルトのキーマップは以下の通りです．
Vespaでは，レイヤーという概念を使用して，同じキーに複数の機能を割り当てることができます．
Enterキーを長押しするとレイヤー1(下の図で"first")，Spaceキーを長押しするとレイヤー2(下の図で"second")に切り替わります．
例えば，`=`キーを入力する場合，Enterキーを長押ししながら右上の`-`キーを押します．`+`を入力する場合は，さらにShiftキーを押しながら同じ操作を行います．

![Vespaキーマップ](../assets/vespa/keymap.svg)

## キーマップの変更

キーマップの変更は[ZMK Studio](https://zmk.studio)を使用して行います．
[アプリ版ZMK Studio](https://zmk.studio/download)ではBluetooth経由のキーマップ変更が可能です．

1. [ZMK Studio](https://zmk.studio)にアクセス，またはアプリを起動します．
2. キーボードをUSBケーブル等で接続します．
3. "Unlock To Continue" というダイアログが表示されたら，キーボードの四隅のキーを同時に押してください(長押ししないでください)．

![Vespa combo](../assets/vespa/keymap_combo.svg)

4. キーを選択して好きなキーコードなどを割り当てることができます．レイヤーを追加したりすることも可能です．
5. 最後に，右上の"Save"ボタンを押してキーマップを保存します．

キーマップ設定についての詳細は，[ZMKのドキュメント(Keymaps & Behaviors)](https://zmk.dev/docs/keymaps)を参照してください．

## 複数のデバイスとペアリングする

Vespaは最大5台のデバイスとペアリングできます．
`BT 0`から`BT 4`までのキーを押すと，接続先デバイスを切り替えることができます．

例えば，最初にPCに接続していて，タブレットにも接続したい場合，以下の手順で行います:

1. Bluetoothプロファイルのうち，`BT 0`はPCとの接続に使用されており，`BT 1`から`BT 4`は未使用です．
2. 未使用のプロファイルのいずれか(例えば`BT 1`)を選択(デフォルトではレイヤー2で`2`キー)すると，キーボードがペアリングモードに入ります．
3. タブレットのBluetooth設定画面を開き，"Vespa"を選択してペアリングを行います．
4. 以降，`BT 0`キーを押すとPCに接続，`BT 1`キーを押すとタブレットに接続されます．

プロファイルを未使用に戻す場合は，`BT CLR`キー(デフォルトではレイヤー2で`0`キー)を押してペアリング情報をクリアしてください．

## スリープ機能をオフにする

スリープ機能をオフにする場合，以下の手順で行います:

1. [ファームウェアのダウンロードページ](https://github.com/object1037/vespa-zmk-module/releases/tag/v1.1)から，`vespa_firmware.zip`をダウンロードします．
2. ダウンロードしたZIPファイルを解凍し，中に`vespa_fw_caffeinated.uf2`というファイルが含まれていることを確認します．
3. キーボードをUSBケーブルでパソコンに接続します．
4. キーボードの四隅のキーを3秒以上同時に押し続けます．
5. キーボードが外部記憶ディスクとして認識されるので，その中に`vespa_fw_caffeinated.uf2`をコピーします．
6. コピーが完了し，ディスクが自動的に取り外されたら完了です．

> [!NOTE]
> ファームウェアのコピー時に，ファイル転送やディスク取り出しに関するエラーが表示されることがありますが，問題ありません．

スリープ機能を再度有効にする場合は，同様の手順で`vespa_fw.uf2`を使用してください．

## トラブルシューティング

### Bluetooth接続できない

以下の点を確認してください：

- 電池を新品に交換してみてください．
- キーボードの電源を一度オフにしてから再度オンにしてみてください．
- `BT_SEL`が割り当てられているキー(デフォルトではレイヤー2で`1`から`5`キー)を押してBluetoothプロファイルを切り替えてみてください．
- キーマップで出力先変更のキーを割り当てている場合，`OUT_BLE`や`OUT_TOG`が割り当てられているキーを押してみてください．
- 以上を試しても接続できない場合，`BT_CLR`や`BT_CLR_ALL`が割り当てられているキー(デフォルトではレイヤー2で`0`, `-`キー)を押してペアリング情報をクリアし，再度ペアリングを試みてください．

### 記号が正しく入力できない

「[キーボードをBluetoothで接続する](#キーボードをBluetoothで接続する)」を参照し，PC等の設定でキーボードの種類・レイアウトを正しく設定してください．

## 参考情報

ハードウェアの設計情報やファームウェアのソースコード，ケースの3Dプリント用データ等は，[こちらのGitHubリポジトリ](https://github.com/object1037/Vespa)から入手できます．
